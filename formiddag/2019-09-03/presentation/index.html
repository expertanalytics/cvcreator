<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>How to squeeze a polynomial into a numpy datatype</title><meta charset="UTF-8"></meta><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        showProcessingMessages: false,
        messageStyle: "none",
        TeX : { extensions : ['color.js'] }
      });
    </script></head><body class="impress-not-supported"><div id="impress" data-transition-duration="500"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="how-to-squeeze-a-polynomial-into-a-numpy-datatype">How to squeeze a polynomial into a numpy datatype</h1><p>By Jonathan Feinberg</p></div><div class="step step-level-1" step="1" data-x="1000" data-y="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-z="0"><h1 id="background-chaospy-use-polynomial-model-approximation">Background: Chaospy use polynomial model approximation</h1><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="n">distribution</span> <span class="o">=</span> <span class="n">chaospy</span><span class="o">.</span><span class="n">J</span><span class="p">(</span><span class="n">chaospy</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">chaospy</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">polynomial_expansion</span> <span class="o">=</span> <span class="n">chaospy</span><span class="o">.</span><span class="n">orth_ttr</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">distribution</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">polynomial_expansion</span><span class="p">)</span>
<span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">q1</span><span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">q0</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">q1</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="mf">0.3</span><span class="n">q1</span><span class="o">+</span><span class="mf">0.0216667</span><span class="p">,</span>
 <span class="n">q0q1</span><span class="o">-</span><span class="mf">0.15</span><span class="n">q0</span><span class="o">-</span><span class="mf">1.5</span><span class="n">q1</span><span class="o">+</span><span class="mf">0.225</span><span class="p">,</span> <span class="n">q0</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="mf">3.0</span><span class="n">q0</span><span class="o">+</span><span class="mf">2.16667</span><span class="p">]</span></pre></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="2000" data-y="0" data-z="0"><h1 id="primitive-solutions-dicts-and-numpy">Primitive solutions: Dicts and Numpy</h1><p>Place numerical arrays into polynomial coefficients:</p><pre class="highlight code">+--+--+--+     +--+--+--+        +--+--+--+
| 1| 2| 3|     | 5| 6| 7|        | 7| 6| 5|
+--+--+--+  +  +--+--+--+ q0  +  +--+--+--+ q0 q1^2  +  ...
| 2| 4| 6|     | 2| 4| 6|        | 2| 4| 6|
+--+--+--+     +--+--+--+        +--+--+--+</pre><p>In practice:</p><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">polynomial_expansion</span><span class="p">)</span>
<span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">q1</span><span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">q0</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">q1</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="mf">0.3</span><span class="n">q1</span><span class="o">+</span><span class="mf">0.02167</span><span class="p">,</span>
 <span class="n">q0q1</span><span class="o">-</span><span class="mf">0.15</span><span class="n">q0</span><span class="o">-</span><span class="mf">1.5</span><span class="n">q1</span><span class="o">+</span><span class="mf">0.225</span><span class="p">,</span> <span class="n">q0</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="mf">3.0</span><span class="n">q0</span><span class="o">+</span><span class="mf">2.16667</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">polynomial_expansion</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
<span class="p">{(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span>    <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span>   <span class="mf">0.</span><span class="p">]),</span>
 <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span>  <span class="mf">0.02167</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">,</span> <span class="mf">2.16667</span><span class="p">]),</span>
 <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>   <span class="mf">1.</span><span class="p">,</span>      <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">]),</span>
 <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>   <span class="mf">0.</span><span class="p">,</span>      <span class="mf">0.</span><span class="p">,</span>    <span class="mf">1.</span><span class="p">]),</span>
 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>    <span class="mf">1.</span><span class="p">,</span>   <span class="mf">0.</span><span class="p">,</span>     <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.</span><span class="p">]),</span>
 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>   <span class="mf">0.</span><span class="p">,</span>      <span class="mf">1.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">])}</span></pre></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3000" data-y="0" data-z="0"><h1 id="approach-has-a-lot-of-problems">Approach has a lot of problems</h1><ul><li>Maintenance burden:<pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="n">polynomial_expansion</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span></pre></li><li>No numpy compatibility:<pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">polynomial_expansion</span><span class="p">)</span>  <span class="c1"># fails</span></pre></li><li>Order of operations not always intuitive:<pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">polynomial_expansion</span>              <span class="c1"># Poly</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span> <span class="o">-</span> <span class="n">polynomial_expansion</span> <span class="c1"># numpy object type</span></pre></li></ul></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4000" data-y="0" data-z="0"><h1 id="where-is-there-room-to-place-a-full-polynomial">Where is there room to place a full polynomial?</h1><img src="./dtype-hierarchy.png"></img></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="5000" data-y="0" data-z="0"><h1 id="flexible-dtype-void-is-used-for-structured-arrays">Flexible dtype <tt>void</tt> is used for Structured Arrays</h1><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"U20"</span><span class="p">),</span>
<span class="o">...</span>                      <span class="p">(</span><span class="s2">"awesome"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">),</span>
<span class="o">...</span>                      <span class="p">(</span><span class="s2">"style"</span><span class="p">,</span> <span class="s2">"i8"</span><span class="p">)])</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Ola"</span><span class="p">,</span> <span class="s2">"Alocias"</span><span class="p">,</span> <span class="s2">"Jonathan"</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s2">"awesome"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s2">"style"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9000</span><span class="p">,</span> <span class="mi">2</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="p">[(</span><span class="s1">'Ola'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>    <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="s1">'Alocias'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9000</span><span class="p">)</span> <span class="p">(</span><span class="s1">'Jonathan'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>    <span class="mi">2</span><span class="p">)]</span></pre></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6000" data-y="0" data-z="0"><h1 id="warning-serious-hack-attempt-ahead">Warning -- Serious Hack attempt ahead</h1></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="7000" data-y="0" data-z="0"><h1 id="masking-structured-array-as-polynomial">Masking structured array as polynomial</h1><p>Use printable string values as substitute for numbers:</p><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">printable</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">printeable</span><span class="p">)</span>
<span class="mo">01234567</span><span class="mi">89</span><span class="n">abcdefghijklmnopqrstuvwxyzABCDEFGHIJK</span><span class="o">...</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">FORWARD_DICT</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">printable</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">"U1"</span><span class="p">)))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">FORWARD_MAP</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">FORWARD_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">exponents</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">exponents_as_strings</span> <span class="o">=</span> <span class="n">FORWARD_MAP</span><span class="p">(</span><span class="n">exponents</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s2">"U2"</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">exponents_as_strings</span><span class="p">)</span>
<span class="p">[</span><span class="s1">'00'</span> <span class="s1">'01'</span> <span class="s1">'10'</span><span class="p">]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">INVERSE_DICT</span> <span class="o">=</span> <span class="p">{</span><span class="n">value</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">FORWARD_DICT</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">INVERSE_MAP</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">INVERSE_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">INVERSE_MAP</span><span class="p">(</span><span class="n">exponents_as_strings</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s2">"U1"</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="p">[[</span><span class="mi">0</span> <span class="mi">0</span><span class="p">]</span>
 <span class="p">[</span><span class="mi">0</span> <span class="mi">1</span><span class="p">]</span>
 <span class="p">[</span><span class="mi">1</span> <span class="mi">0</span><span class="p">]]</span></pre></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="sublcassing-numpy-ndarray-is-easy">Sublcassing <tt>numpy.ndarray</tt> is easy</h1><pre class="highlight code python"><span class="k">class</span> <span class="nc">ndpoly</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>

   <span class="n">__array_priority__</span> <span class="o">=</span> <span class="mi">16</span>

   <span class="n">_dtype</span> <span class="o">=</span> <span class="bp">None</span>
   <span class="n">_exponents</span> <span class="o">=</span> <span class="bp">None</span>
   <span class="n">_indeterminants</span> <span class="o">=</span> <span class="bp">None</span>

   <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span>
            <span class="n">exponents</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,),),</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(),</span>
            <span class="n">indeterminants</span><span class="o">=</span><span class="s2">"z"</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
   <span class="p">):</span>
      <span class="n">exponents</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exponents</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
      <span class="n">dtype_</span> <span class="o">=</span> <span class="s2">"S</span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="n">exponents</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

      <span class="c1"># ...</span>

      <span class="n">exponents</span> <span class="o">=</span> <span class="n">FORWARD_MAP</span><span class="p">(</span><span class="n">exponents</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
      <span class="n">exponents</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exponents</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype_</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">"U"</span><span class="p">)</span>

      <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span> <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">dtype</span>
      <span class="n">dtype_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">exponents</span><span class="p">])</span>

      <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ndpoly</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

      <span class="n">obj</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">dtype</span>
      <span class="n">obj</span><span class="o">.</span><span class="n">_exponents</span> <span class="o">=</span> <span class="n">exponents</span>
      <span class="n">obj</span><span class="o">.</span><span class="n">_indeterminants</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">indeterminants</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">obj</span></pre></div><div class="step step-level-1" step="9" data-x="8000" data-y="500" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-z="0"><pre class="highlight code python"><span class="k">def</span> <span class="nf">__array_finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">return</span>
   <span class="bp">self</span><span class="o">.</span><span class="n">_exponents</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">"_exponents"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
   <span class="bp">self</span><span class="o">.</span><span class="n">_indeterminants</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">"_indeterminants"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
   <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">"_dtype"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></pre></div><div class="step step-level-1" step="10" data-x="9000" data-y="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-z="0"><h1 id="we-can-store-but-how-about-manipulations">We can store, but how about manipulations?</h1><pre class="highlight code python"><span class="c1"># ...</span>
   <span class="k">def</span> <span class="nf">__array_ufunc__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ufunc</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

      <span class="c1"># ...</span>
      <span class="k">if</span> <span class="n">ufunc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">array_function</span><span class="o">.</span><span class="n">ARRAY_FUNCTIONS</span><span class="p">:</span>
         <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ndpoly</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__array_ufunc__</span><span class="p">(</span>
            <span class="n">ufunc</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">array_function</span><span class="o">.</span><span class="n">ARRAY_FUNCTIONS</span><span class="p">[</span><span class="n">ufunc</span><span class="p">](</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="nd">@implements</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
   <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">numpoly</span><span class="o">.</span><span class="n">align_polynomials</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
   <span class="n">collection</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">todict</span><span class="p">()</span>
   <span class="k">for</span> <span class="n">exponent</span><span class="p">,</span> <span class="n">coefficient</span> <span class="ow">in</span> <span class="n">x2</span><span class="o">.</span><span class="n">todict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">collection</span><span class="p">[</span><span class="n">exponent</span><span class="p">]</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">exponent</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span><span class="o">+</span><span class="n">coefficient</span>
   <span class="n">exponents</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
   <span class="n">coefficients</span> <span class="o">=</span> <span class="p">[</span><span class="n">collection</span><span class="p">[</span><span class="n">exponent</span><span class="p">]</span> <span class="k">for</span> <span class="n">exponent</span> <span class="ow">in</span> <span class="n">exponents</span><span class="p">]</span>
   <span class="k">return</span> <span class="n">numpoly</span><span class="o">.</span><span class="n">polynomial_from_attributes</span><span class="p">(</span>
      <span class="n">exponents</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">x1</span><span class="o">.</span><span class="n">_indeterminants</span><span class="p">)</span></pre></div><div class="step step-level-1" step="11" data-x="10000" data-y="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-z="0"><h1 id="cherry-on-top-numpy-function-compatibility">Cherry on top: Numpy function compatibility!</h1><pre class="highlight code python"><span class="k">def</span> <span class="nf">__array_function__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">array_function</span><span class="o">.</span><span class="n">ARRAY_FUNCTIONS</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ndpoly</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__array_function__</span><span class="p">(</span>
            <span class="n">func</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">array_function</span><span class="o">.</span><span class="n">ARRAY_FUNCTIONS</span><span class="p">[</span><span class="n">func</span><span class="p">](</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></pre></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11000" data-y="0" data-z="0"><h1 id="but-does-it-work">But does it work?</h1></div></div><div id="hovercraft-help"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>G</th><td>Go to slide number</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>